parameters:
  serviceConnection: ''
  aksResourceGroup: ''
  aksClusterName: ''

steps:
- task: HelmDeploy@0
  displayName: 'Install Nginx Ingress Controller'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscription: ${{ parameters.serviceConnection }}
    azureResourceGroup: ${{ parameters.aksResourceGroup }}
    kubernetesCluster: ${{ parameters.aksClusterName }}
    command: 'install'
    chartType: 'Name'
    chartName: 'stable/nginx-ingress'
    arguments: '--namespace kube-system --set controller.replicaCount=2'

- task: Kubernetes@1
  displayName: 'Get Public IP of Nginx Ingress Controller'
  inputs:
    connectionType: 'Azure Resource Manager'
    azureSubscriptionEndpoint: ${{ parameters.serviceConnection }}
    azureResourceGroup: ${{ parameters.aksResourceGroup }}
    kubernetesCluster: ${{ parameters.aksClusterName }}
    command: 'get service'
    arguments: '-w -l app=nginx-ingress --namespace kube-system'
    outputFormat: 'name'
